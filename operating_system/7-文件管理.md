# 实验7 文件管理

- 实验内容:
    计算机系统所用的大量程序和数据等信息，平时都以文件的形式存放在磁盘、磁带、光盘等外部存储器中，需要的时候可以随时装入内存。这些文件信息无论对系统还是对用户来说，都是非常重要的，因此，如何保证这些软资源存放时安全又高效、使用时方便又快捷，是操作系统中文件管理模块必须解决的问题。通过本次实验，你将学习操作系统文件管理机制，掌握磁盘块的分配算法和回收算法。此后需要你在模拟框架内补充相关代码、实现相关接口，实现一个小型文件系统。

- 实验要点:
    了解文件系统的概念，熟悉文件系统的功能；
    通过模拟实验掌握文件系统对与文件的创建、删除、打开、关闭、读和写等基本操作进行处理的。

- 实验目的
    1.了解文件系统的概念，熟悉文件系统的功能；
    2.通过模拟实验掌握文件系统对与文件的创建、删除、打开、关闭、读和写等基本操作进行处理的。

## 文件系统概述

文件是由操作系统定义并实现的一种抽象数据类型，它是逻辑记录的序列。一个记录可能是一行数据或一个字节。操作系统可支持不同的记录类型，当然它们应由相应的应用程序来定义和解释。

文件系统最基本的目标是实现文件按名存取，这主要是通过文件系统的目录管理功能来实现。文件系统所追求的的最重要的目标是提高对文件的存取速度。一个较为完整的文件系统应具有以下功能。

- 文件读写管理：

    提供合适的文件存取方法，根据用户请求尽快地完成文件的读写管理。
- 文件目录管理：

    建立和维护目录，实现对文件按名存取，提供快速的目录检索。
- 文件存储空间管理：

    为每个文件分配必要的外存空间，提高外存利用率，提高文件系统的工作速度。
- 文件保护与共享：

    实现多个用户对同一个文件的共享访问，并提供存取控制等保护措施。
- 提供方便的接口：

    通过系统的命令接口和程序接口，提供一组可供用户使用的文件系统，方便用户对文件的使用和管理。
- 文件系统的可靠性与一致性：

    提供文件的备份、转储与恢复机制，并能验证文件的正确性，具有一定的差错恢复能力。

### 一、文件

操作系统管理的文件是指外部存储器中具有符号名的一组相关信息的集合。通常文件在逻辑上由若干个记录组成。记录是一些相关数据项的集合，而数据项是数据组织中可以命名的最小逻辑单位，用于描述一个实体的某种属性。因此，文件也是具有符号名的记录的集合，特别是在早起的系统和现在的数据库管理系统中。

文件包括文件体和文件说明两部分。

- 文件体：

    指文件本身的信息。这是操作系统管理的一种软资源对象。

- 文件说明：

    指文件存储和管理信息，例如，文件名、文件内部标识、文件存储地址、访问权限和访问时间等。这是操作系统为管理文件对象而需要的管理控制信息，也可看成是文件的属性，通常存放在文件目录之类的数据结构中。

文件的表示范围很广，系统或用户可以将具有一定功能的程序或数据集合命名后存储为一个文件。

例如，一个命名的源程序、目标程序、一批数据，以及系统程序都可看作文件。在许多操作系统中，设备也被看作赋予特殊文件名的文件。这样，系统可以对设备和文件实施统一管理，既简化了系统设计又方便了用户。

### 二、文件系统

操作系统中负责存取和管理文件信息的模块称为文件系统。它用统一的方式管理信息的存储、检索、更新、共享和保护，并为用户提供一整套方便有效的文件使用和操作方法。文件这一术语不但反映了用户概念中的逻辑结构，而且与存放它的辅助存储器的存储结构也是紧密相关的。

从系统角度看，文件系统是对文件的存储空间进行组织、分配，负责文件的存储并对存入的文件进行保护。检索的系统。它负责为用户建立。撤销、读写、修改和复制文件。从用户角度看，文件系统主要实现了按名存取。也就是说，当用户要求系统保存一个已命名文件时，操作系统以一定的格式将用户的文件存放到文件存储器中适当的位置；当用户要使用文件时，系统根据用户所给的文件名能够从文件存储器中找到所要的文件。对用户来说它提供了一种便捷的存取信息的方法：按文件名存取信息，无须了解文件存储的物理位置。从这种意义上讲，文件系统是用户与外存的接口，这里把设备管理模块看作文件系统的底层。更严格的说法是文件系统位于用户和设备驱动程序之间。一种文件系统的样例结构如图所示。

### 三、目录

文件目录主要用于文件的描述与控制，实现稳健的按名存取和文件信息共享和保护。

文件目录项，又称文件控制块（File Control Block，FCB）随文件的建立而建立，随文件的删除而消亡，它对于文件，就像PCB对进程一样。

## 磁盘空间管理

磁盘是大容量的随机存取设备，它是被操作系统和许多用户所共享的一种典型的外部存储器。

磁盘文件可长期保存，也经常被用户创建和删除。如何有效地给新建文件分配磁盘空间，如何及时地回收被删除文件所占的空间，以提高磁盘利用率是文件系统应该解决的一个重要问题。

新创建文件的存储空间分配原则有以下两种。

- 预分配。创建时（这是已知文件长度）一次性分配指定的存储空间，例如文件复制时目标文件的创建。

- 动态分配。需要存储空间时才分配（创建时无法确定文件长度），例如写入数据到文件。

与内存分配相似，常用的外存空间分配办法有连续分配和不连续分配两种。
连续分配实现了顺序文件，FCB中只记录第一个块的位置，适用于预分配原则，可通过紧缩将外存空闲空间合并成连续区域。

连续分配的优点主要是顺序访问时通常无需径向移动磁头，文件查找速度快，管理较为简单；缺点是会造成磁盘“碎片”，导致磁盘利用率较低，不适于文件频繁进行动态增长和收缩的情况，也不适于不知道新建文件长度的情况。

不连续分配实现了链接文件和索引文件。

一种不连续分配方法是以扇区为单位，按文件动态要求分配给它若干扇区，这些扇区可以不连续，属于同一文件的扇区按文件记录的逻辑次序用链指针链接或用位示图指示。

另一种不连续分配方法是以簇或块为单位，簇是由若干连续扇区组成的分配单位，因而这种分配方法实质上是连续分配和不连续分配的结合。与内存分页管理相似，不连续分配的有点主要是外存空间利用率高，便于文件动态增长和收缩，访问文件的速度快。

## 文件操作

使用文件的目的是存储信息并方便以后检索。不同的系统提供不同的文件操作命令和系统调用，其中有很多命令早已为广大的计算机用户所熟悉。

从某种意义上说，用户使用计算机的主要目的就是要访问存储在外存中的文件。而要访问这些文件，可以通过文件系统提供的两类接口进行。第一类是与文件有关的一组操作命令或作业控制语言中与文件有关的一组JCL语句，例如，UNIX系统中的cat、cp、find、mv、rm等命令，MS-DOS中的type、copy、delete、rename、attrib等命令，Windows中的搜索工具集成了建立、删除、复制、粘贴、改名等功能于一身的资源管理器或我的电脑命令工具等，这些构成了必不可少的命令级的文件系统人机接口。第二类是提供给用户程序使用的一组文件系统调用，它们构成了程序级的用户和文件系统的接口。通过这些接口，用户能够获得文件系统的各种服务，从而很轻松地完成所需要的各种文件操作，例如创建、打开、读、写、关闭和删除文件等。实际上，正是文件系统提供的这两类接口，使用户对文件的操作更加简单、方便和有效。

现在请你在提供的框架下，实现操作系统提供的最通常的一些文件类系统调用。

- CREATE，创建文件。创建无任何数据的文件。
- DELETE，删除文件。当不再需要某个文件时，必须删除它以释放外存空间。
- READ，读文件。在文件中读数据。一般，读出的数据来自文件读写指针的当前位置。在每次读写完成后，读写指针会随着信息读写的数据量自动后移相应数值。
- WRITE，写文件。在文件中写数据。写操作一般也是从文件读写指针的当前位置开始。如果当前位置是文件末尾，则文件长度增加；如果当前位置在文件中间，则现有数据被覆盖，并且永远丢失掉。

## 文件系统模拟实验提高实验

进入/headless/Desktop/os/project7/目录，打开该目录下的filesystemhard.c文件，浏览源代码。

可以看到，我们主要定义了mkdir()、create()、read()、write()、del()、rm()和cd()函数，它们的功能分别是创建目录、创建文件、读文件、写文件、删除文件、删除目录和进入目录，但是部分函数留有空白，需要你将其补全。

节点分为目录节点和文件节点，先查看创建节点的函数，第二个参数isdir为1表示创建的是目录，为0表示创建的是文件。

```c
filenode* initnode(char filename[],int isdir)
{
	filenode *node=new filenode;
	strcpy(node->filename,filename);
	node->isdir=isdir;
	node->parent=NULL;
	node->child=NULL;
	node->prev=NULL;
	node->next=NULL;
	return node;
}
```

### 一、创建目录

创建目录，需要新创建一个节点并将其插入应在的位置。查看mkdir()函数，补全关键代码。

```c
1  temp=initnode(" ",1);
2  if(recent->child==NULL)  
3  {//待补全
4	printf("目录建立成功!\n");
5  }
```

### 二、创建文件

与创建目录类似，将第二个参数改为0，创建成功后同样将其插入应在的位置。查看create()函数，补全关键代码。

```c
1  temp=initnode(" ",0);
2  if(recent->child==NULL)  
3  { //待补全
4	printf("文件建立成功!\n");
5  }
```

### 三、写文件

首先找到对应文件，本实验采用直接全部覆盖写，未指定位置，若无该文件，则写失败。查看read()函数，补全关键代码。

```c
1  if(strcmp(recent->child->filename,filename)==0)
2  {//待补全
3  }
```

### 四、读文件

同样找到对应文件，将文件内容读出，如无该文件，则读失败。查看read()函数，补全关键代码。

```c
1  if(strcmp(recent->child->filename,filename)==0){
2        //待补全 
3    }
```

### 五、删除文件

删除文件，实则为删除该节点与与该节点相关的索引，如果该文件不存在，则删除失败。查看del()函数，补全关键代码。

```c
1  if(temp->parent==NULL)
2  {//待补全
3  }
4  else
5  {//待补全
6  }
7  free(temp);
```

### 六、删除目录

删除目录，需要删除该目录节点本身，同时还需删除其父节点对该目录的索引，当然如果想要删除的目录不存在，同样删除失败。查看rm()函数，补全关键代码，发现与del()高度相似。

```c
1  if(temp->parent==NULL)
2  {//待补全
3  }
4  else
5  {//待补全
6  }
7  free(temp);
```
